import sys,os
from PySide import QtGui, QtCore
from octopod import *
import numpy as np
import octopod_config as ocfg
from octopod.Processor import process
from octopod import DispersionOptimizer
from pyqtgraph import ImageView
import DispersionGui_UI as ui





class DispersionGui(QtGui.QMainWindow):

    def __init__(self):
        super(DispersionGui, self).__init__()
        self.init_UI()
        
    def init_UI(self):

        # set up layout
        self.layout = QtGui.QGridLayout()
        self.layout.setSpacing(10)

        
        # set up menu actions

        open_action = QtGui.QAction(QtGui.QIcon('open.png'), '&Open', self)
        open_action.setShortcut('Ctrl+O')
        open_action.setStatusTip('Open a file')
        open_action.triggered.connect(self.open_file)
        
        exit_action = QtGui.QAction(QtGui.QIcon('exit.png'), '&Exit', self)
        exit_action.setShortcut('Ctrl+Q')
        exit_action.setStatusTip('Exit application')
        exit_action.triggered.connect(self.close)

        menubar = self.menuBar()
        file_menu = menubar.addMenu('&File')
        file_menu.addAction(open_action)
        file_menu.addAction(exit_action)
        
        self.statusBar()


        canvas = ImageView()
        self.layout.addWidget(canvas,0,0,5,10)

        self.setLayout(self.layout)
        
        
        # set up geometry and draw
        self.setMinimumWidth(1800)
        self.setMinimumHeight(1000)

        
        self.show()

    def open_file(self):
        fname = QtGui.QFileDialog.getOpenFileName(self, 'Open file',ocfg.data_root)[0]
        if os.path.exists(fname):
            self.setStatusTip('Working file: %s'%fname)
            self.h5 = h5py.File(fname)
            self.dispersion_optimizer = DispersionOptimizer(self.h5)
            self.raw_vol = self.h5['raw_data'][0,:,:,:]
            self.k_in = self.h5['k_in'][:]
            self.k_out = self.h5['k_out'][:]
            self.coefficients = self.h5['dispersion']['coefficients'][:]
            self.bscan = self.get_bscan()

    def get_bscan(self,index=0):
        return process(self.raw_vol[index,:,:],self.k_in,self.k_out,self.coefficients)[:,2:]
        
            


def main():
    
    app = QtGui.QApplication(sys.argv)

    ex = DispersionGui()

    sys.exit(app.exec_())
    sys.exit()

if __name__ == '__main__':
    main()
